<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebApp с WebSocket</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    button { background-color: #0078d7; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 10px; cursor: pointer; }
    #status { margin-top: 20px; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <h1>WebApp с WebSocket</h1>
  <button id="btnClick">Нажми меня</button>
  <div id="status">Статус: Подключение...</div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id || "unknown";
    const statusEl = document.getElementById("status");
    const btn = document.getElementById("btnClick");

    // Замени на твой Pinggy URL
    const WS_BASE = "wss://<твой-pinggy-url-здесь>"; // e.g., wss://abc.pinggy.link
    const ws = new WebSocket(`${WS_BASE}/ws?user_id=${userId}`);

    ws.onopen = () => {
      statusEl.textContent = `Статус: Подключено как ${userId}`;
      console.log("WS connected at", new Date().toISOString());
    };

    ws.onerror = (e) => {
      statusEl.textContent = "Статус: Ошибка WS";
      console.error("WS error:", e);
    };

    ws.onclose = (e) => {
      statusEl.textContent = `Статус: Закрыто (${e.code}, reason: ${e.reason || 'none'})`;
      console.log("WS closed at", new Date().toISOString(), e);
    };

    ws.onmessage = (msg) => {
      console.log("Message from server:", msg.data, new Date().toISOString());
    };

    btn.onclick = () => {
      if (ws.readyState === WebSocket.OPEN) {
        const data = { action: "click", user: userId, timestamp: Date.now() };
        ws.send(JSON.stringify(data));
        console.log("Sent at", new Date().toISOString(), data);
      } else {
        console.warn("WS not connected, state:", ws.readyState);
        alert("WS не подключён, проверь консоль");
      }
    };

    // Клиентский ping для keep-alive
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action: "ping" }));
        console.log("Sent ping at", new Date().toISOString());
      }
    }, 25000);
  </script>
</body>
</html>
