<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS test</title>
</head>
<body style="font-family: sans-serif; background:#0f172a; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;">
  <h2>WebSocket —Ç–µ—Å—Ç</h2>
  <button id="btn" style="padding:12px 20px; border-radius:8px; font-size:16px; cursor:pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
  <pre id="log" style="margin-top:20px; width:90%; max-width:600px; background:#071029; padding:12px; border-radius:8px; min-height:120px;"></pre>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const logEl = document.getElementById('log');
    function log(...args){ console.log(...args); logEl.textContent += args.join(' ') + '\n'; logEl.scrollTop = logEl.scrollHeight; }

    const tg = window.Telegram?.WebApp;
    if (!tg) {
      log("‚ö†Ô∏è Telegram.WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–∫—Ä—ã—Ç–æ –Ω–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞?");
    }
    // –ü–æ–ª—É—á–∞–µ–º user id ‚Äî –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –ø–æ–¥—Å—Ç–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π id
    const userId = tg?.initDataUnsafe?.user?.id || (Math.floor(Math.random()*900000)+100000);
    log("userId =", userId);

    // <- –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô PUBLIC URL (dev tunnel) –ë–ï–ó –°–õ–ï–®–ê –ù–ê –ö–û–ù–¶–ï
    const WS_BASE = "https://dnjzwnbf-8080.euw.devtunnels.ms";

    const wsUrl = `wss://${WS_BASE.replace(/^https?:\/\//, '')}/ws?user_id=${userId}`;
    log("WS URL:", wsUrl);

    let ws;
    function connect() {
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log("‚úÖ WebSocket: connected");
      };
      ws.onmessage = (ev) => {
        log("üì© From server:", ev.data);
      };
      ws.onerror = (e) => {
        log("‚ùå WebSocket error", e);
      };
      ws.onclose = (ev) => {
        log("üîí WebSocket closed", ev.code, ev.reason);
        // –º–æ–∂–Ω–æ reconnect —á–µ—Ä–µ–∑ –ø–∞—É–∑—É, –Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–µ –±—É–¥–µ–º
      };
    }

    connect();

    document.getElementById('btn').addEventListener('click', () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log("‚ö†Ô∏è WS –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ OPEN. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...");
        connect();
        setTimeout(() => log("–ü–æ–¥–æ–∂–¥–∏—Ç–µ 1s –∏ –Ω–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑"), 500);
        return;
      }
      const payload = { action: "click", from: userId, ts: Date.now() };
      log("üì§ Send:", JSON.stringify(payload));
      ws.send(JSON.stringify(payload));
    });
  </script>
</body>
</html>
